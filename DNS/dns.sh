#!/bin/bash
# Written by David Serate
# Does something to update DNS
# This is not designed to be extensible - only to manage my local dns in 3 zones
# blue.local 
# red.local
# routing.local

if (( $EUID != 0 )); then 
	echo "Run with sudo privileges"
	exit
fi
# Parse options from the
while getopts "cui:n:z: " option; do
	val=$OPTARG
	case $option in
		c)
			# Create the files
			action="create"
		;;
	
		e)	
			# Update the forward and reverse entries
			action="edit"
		;;

		z)
			# Zone
			zone=$val
		;;

		i)
			# IP 
			ip=$val
		;;

		n)
			# Name
			name=$val
		;;
	esac	
done

# Handle executing everything
case $action in
	"create")
		# Create files 
		zones=("red" "blue" "routing")

		# IPs for the new networks
		ips=("20.0.5" "10.0.5" "30.0.5")


		serial=3
		mkdir /etc/bind/zones
		cp /etc/bind/named.conf.local /etc/bind/named.conf.local.old
		for i in ${!zones[@]} 
		do
			cd /etc/bind/zones
			echo "Creating ${zones[i]} forward zone file."
			# Create the specific forward lookup zone file
			touch db.${zones[i]}.local
			echo -e "$TTL \t 604800" > db.${zones[i]}.local
			echo -e "@ \t IN \t SOA \t ${zones[i]}.local. \t root.${zones[i]}.local. ($serial);" >> db.${zones[i]}.local
			
			# not hardcoding the reversed IPs 
			1octet=$(echo "10.0.5.2" | cut -d. -f 1)
			2octet=$(echo "10.0.5.2" | cut -d. -f 2)
			3octet=$(echo "10.0.5.2" | cut -d. -f 3)
			rip="$3octet.$2octet.$1octet"

			echo "Creating ${zones[i]} reverse zone file."
			# Create the reverse lookup zone file 
			touch db.${rip}.local
			echo -e "$TTL \t 604800" > db.${rip}.local
			echo -e "@ \t IN \t SOA \t ${zones[i]}.local. \t root.${zones[i]}.local. ($serial);" >> db.${rip}.local
			
			# Increment serial
			serial=$(($serial + 1))
			
			# Go up a directory from /etc/bind/zones to /etc/bind/
			cd ..

			# wget the template 
			wget -O namedlocal https://raw.githubusercontent.com/SirSertile/pentestlab/master/DNS/namedlocal
			# Replace the ZONE with the zone name
			sed -i "s/ZONE/${zones[i]}.local/g" namedlocal
			# Repalce the RIP with the IP
			sed -i "s/RIP/${rip}/g" namedlocal
			# Repalce the RZON with the reverse zone name
			sed -i "s/RZON/${rip}.local/g" namedlocal


			# Add a segment to the named.conf.local
			if [ -z "$(grep -x "$(sed -n -e 1p namedlocal)" named.conf.local)" ] && [ -z "$(grep -x "$(sed -n -e 5p namedlocal)" named.conf.local)" ]; then
				echo "added namedlocal stuff"
				sed -n -e 5p namedlocal
				sed -n -e 1p namedlocal
				cat namedlocal >> named.conf.local
			fi

			# rm namedlocal to clean up 
			rm namedlocal
		done
		ufw allow bind9
	;;
	edit)
		# Make sure you have all the variables
		if [ -z $ip -a -z $name -a -z $zone ]; then
			echo "Please specify the name(-n), IP(-i), zone(-z)."
			exit 1
		else
			cd /etc/bind/zones
			# Make A records filename
			afile=db.$zone.local
			# Make backup of the zone file
			cp $afile $afile.old
			# Remove the line that matches 
			sed "s/^$name\.$zone\.[[:blank:]]IN[[:blank:]]A*/$name\.$zone\.\tIN\tA\t$ip" $afile.old > $afile
			
			# Were any changes made? 
			if [ "$(cat $afile)" = "$(cat $afile.old)" ]; then
				# No changes were made - append to the file
				echo -e "$name.$zone.\tIN\tA\t$ip" >> $afile
				echo "New A Record created."
			else
				echo "A Record modified."
			fi
			
			# Make PTR records filename
			1octet=$(echo "10.0.5.2" | cut -d. -f 1)
			2octet=$(echo "10.0.5.2" | cut -d. -f 2)
			3octet=$(echo "10.0.5.2" | cut -d. -f 3)
			ptrfile="db.$3octet.$2octet.$1octet.local"
			# Find if the appropriate PTR record file has the entry 

			# If it does, delete it 
			# Create new entry at bottom of file 
			# Make backup of the zone file
			cp $ptrfile $ptrfile.old
			# Remove the line that matches 
			sed "s/^$ip[[:blank:]]IN[[:blank:]]PTR*/$ip\tIN\tPTR\t$name.$zone." $ptrfile.old > $ptrfile
			
			# Were any changes made? 
			if [ "$(cat $ptrfile)" = "$(cat $ptrfile.old)" ]; then
				# No changes were made - append to the file
				echo -e "$name.$zone.\tIN\tA\t$ip" >> $ptrfile
				echo "New PTR Record created."
			else
				echo "PTR Record modified."
			fi
		fi
	;;
esac