#!/bin/bash
# Written by David Serate
# Does something to update DNS
# This is not designed to be extensible - only to manage my local dns in 3 zones
# blue.local 
# red.local
# routing.local

if (( $EUID != 0 )); then 
	echo "Run with sudo privileges"
	exit
fi
while getopts "cui:n:z " option; do
	val=$OPTARG
	case $option in
		c)
			# Create the files
			action="create"
		;;
	
		e)	
			# Update the forward and reverse entries
			action="edit"
		;;

		z)
			# Zone
			zone=$val
		;;

		i)
			# IP 
			ip=$val
		;;

		n)
			# Name
			name=$val
		;;
	esac	
done
# Handle executing everything
case $action in
	"create")
		# Create files 
		zones=("red" "blue" "routing")

		# IPs for the new networks
		ips=("20.0.5" "10.0.5" "30.0.5")
		# I'm lazy so these are hardcoded in as reversed
		rips=("5.0.20" "5.0.10" "5.0.30")

		serial=3
		for i in {0..${#zones[@}}$zones
			cd /etc/bind/zones
			echo "Creating ${zones[i]} forward zone file."
			# Create the specific forward lookup zone file
			touch db.${zones[i]}.local
			echo -e "$TTL \t 604800" > db.${zones[i]}.local
			echo -e "@ \t IN \t SOA \t ${zones[i]}.local. \t root.${zones[i]}.local. ($serial);" >> db.${zones[i]}.local
			
			echo "Creating ${zones[i]} reverse zone file."
			# Create the reverse lookup zone file 
			touch db.${rips[i]}.local
			echo -e "$TTL \t 604800" > db.${rips[i]}.local
			echo -e "@ \t IN \t SOA \t ${zones[i]}.local. \t root.${zones[i]}.local. ($serial);" >> db.${rips[i]}.local
			
			# Increment serial
			$serial+=1
			
			# Add a segment to the named.conf.local
			wget -O namedlocal https://raw.githubusercontent.com/SirSertile/pentestlab/master/DNS/namedlocal
			# Replace the ZONE with the zone name
			sed -i "s/ZONE/${zones[i]}.local/g" namedlocal
			# Repalce the RIP with the IP
			sed -i "s/RIP/${rips[i]}/g" namedlocal
			# Repalce the RZON with the reverse zone name
			sed -i "s/RZON/${zones[i]}/g" namedlocal
			 
		end
		ufw allow bind9
	;;
	"edit")
	
	;;
esac